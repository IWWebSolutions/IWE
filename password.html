<!doctype html>
<html class="no-js" lang="zxx">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.8/lottie.min.js"></script>
    <div id="head"></div>
</head>
<body>
    <!-- Header content will be loaded dynamically -->
    <div id="header"></div>

    <!-- Breadcrumb Area -->
    <div class="breadcrumb-area">
        <div class="container">
            <div class="breadcrumb-content">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li class="active">Forgot Password</li>
                </ul>
            </div>
        </div>
    </div>

<!-- Forgot Password Content Area --> 
<div class="page-section mb-60">
    <div class="container">
        <div class="row">
            <div class="col-sm-12 col-md-12 col-xs-12 col-lg-6 mb-30">
                <!-- Forgot Password Form -->
                <form id="forgotPasswordForm">
                    <div class="login-form">
                        <h4 class="login-title">Let us help you reset your password!</h4>
                        <div class="row">
                            <!-- Email Input -->
                            <div class="col-md-12 col-12 mb-20">
                                <label>Enter your registered email address<span class="red">*</span></label>
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <input class="mb-0" id="email" name="email" type="email" placeholder="Email Address" style="width: 100%; max-width: 400px;">
                                    <button type="submit" id="checkEmailButton" class="register-button" style="margin-top: 10px;">Submit</button>
                                </div>
                                <span class="error" id="emailError" style="display: block; text-align: center;"></span>
                                <span id="emailTick" style="display: none; color: green; text-align: center;">✔</span>
                            </div>

                            <!-- Send OTP Button -->
                            <div class="col-md-12" id="sendOtpSection" style="display: none;">
                                <button type="button" id="sendOtpButton" class="register-button mt-0">Send OTP / Verification Code</button>
                                <span id="otpTimer" style="display: none; color: gray;">Resend OTP in <span id="countdown">60</span> seconds</span>
                            </div>

                            <!-- Register Button (Initially Hidden) -->
                            <div class="col-md-12" id="registerButtonSection" style="display: none;">
                                <button type="button" id="registerButton" class="register-button mt-2" onclick="window.location.href='register.html'">Register</button>
                            </div>

                            <!-- OTP Input -->
                            <div class="col-md-12 col-12 mb-20" id="otpSection" style="display: none;">
                                <label>Enter verification code<span class="red">*</span></label>
                                <input class="mb-0" id="otp" name="otp" type="number" placeholder="Enter OTP">
                                <button type="button" id="submitOtpButton" class="register-button mt-2">Submit OTP</button> <!-- Submit OTP Button -->
                                <span class="error" id="otpError"></span>
                            </div>
                            <!-- New Password Input -->
                            <div class="col-md-12 col-12 mb-20" id="newPasswordSection" style="display: none;">
                                <label>Enter new password<span class="red">*</span></label>
                                <input class="mb-0" id="newPassword" name="newPassword" type="password" placeholder="New Password">
                                <span class="error" id="newPasswordError"></span>
                            </div>
                            <!-- Confirm New Password Input -->
                            <div class="col-md-12 col-12 mb-20" id="confirmPasswordSection" style="display: none;">
                                <label>Confirm new password<span class="red">*</span></label>
                                <input class="mb-0" id="confirmPassword" name="confirmPassword" type="password" placeholder="Confirm New Password">
                                <span class="error" id="confirmPasswordError"></span>
                            </div>
                            <!-- Save and Login Buttons -->
                            <div class="col-md-12" id="saveSection" style="display: none;">
                                <button type="button" id="saveButton" class="register-button mt-0">Save New Password</button>
                                <button type="button" id="loginButton" class="register-button mt-0" onclick="window.location.href='login.html'">Login</button>
                            </div>
                            <!-- Form Response Message -->
                            <div id="formResponse" style="display: none;"></div> 
                        </div>
                    </div>
                </form>
            </div>
            <!-- Right Side: Animation -->
            <div class="col-sm-12 col-md-12 col-xs-12 col-lg-6 mb-30">
                <div id="animationContainer" style="width: 100%; height: 500px;"></div>
            </div>
        </div>
    </div>
</div>


    <!-- Footer content will be loaded dynamically -->
    <div id="footer"></div>

    <!-- Scripts -->
    <!-- jQuery-V1.12.4 -->
    <script src="js/vendor/jquery-1.12.4.min.js"></script>
    <!-- Popper js -->
    <script src="js/vendor/popper.min.js"></script>
    <!-- Bootstrap V4.1.3 Fremwork js -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Ajax Mail js -->
    <script src="js/ajax-mail.js"></script>
    <!-- Meanmenu js -->
    <script src="js/jquery.meanmenu.min.js"></script>
    <!-- Wow.min js -->
    <script src="js/wow.min.js"></script>
    <!-- Slick Carousel js -->
    <script src="js/slick.min.js"></script>
    <!-- Owl Carousel-2 js -->
    <script src="js/owl.carousel.min.js"></script>
    <!-- Magnific popup js -->
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- Isotope js -->
    <script src="js/isotope.pkgd.min.js"></script>
    <!-- Imagesloaded js -->
    <script src="js/imagesloaded.pkgd.min.js"></script>
    <!-- Mixitup js -->
    <script src="js/jquery.mixitup.min.js"></script>
    <!-- Countdown -->
    <script src="js/jquery.countdown.min.js"></script>
    <!-- Counterup -->
    <script src="js/jquery.counterup.min.js"></script>
    <!-- Waypoints -->
    <script src="js/waypoints.min.js"></script>
    <!-- Barrating -->
    <script src="js/jquery.barrating.min.js"></script>
    <!-- Jquery-ui -->
    <script src="js/jquery-ui.min.js"></script>
    <!-- Venobox -->
    <script src="js/venobox.min.js"></script>
    <!-- Nice Select js -->
    <script src="js/jquery.nice-select.min.js"></script>
    <!-- ScrollUp js -->
    <script src="js/scrollUp.min.js"></script>
    <!-- Main/Activator js -->
    <script src="js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.8/lottie.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Load head content
            fetch('head.html')
                .then(res => {
                    if (!res.ok) throw new Error('Head file not found');
                    return res.text();
                })
                .then(data => {
                    document.getElementById('head').innerHTML = data;
                })
                .catch(error => console.error('Error loading head:', error));
    
            // Load header content
            fetch('header.html')
                .then(res => {
                    if (!res.ok) throw new Error('Header file not found');
                    return res.text();
                })
                .then(data => {
                    document.getElementById('header').innerHTML = data;
                })
                .catch(error => console.error('Error loading header:', error));
    
            // Load footer content
            fetch('footer.html')
                .then(res => {
                    if (!res.ok) throw new Error('Footer file not found');
                    return res.text();
                })
                .then(data => {
                    document.getElementById('footer').innerHTML = data;
                })
                .catch(error => console.error('Error loading footer:', error));
        });

        document.addEventListener("DOMContentLoaded", function() {
            // Change href dynamically for .redirect links
            document.querySelectorAll(".redirect").forEach(link => {
                link.setAttribute("href", "maintenance.html");

                link.addEventListener("click", function(event) {
                    event.preventDefault();
                    window.location.href = "maintenance.html";
                });
            });

            // Change href dynamically for .soon links
            document.querySelectorAll(".soon").forEach(link => {
                link.setAttribute("href", "coming-soon.html");

                link.addEventListener("click", function(event) {
                    event.preventDefault();
                    window.location.href = "coming-soon.html";
                });
            });
        });

        const animationContainer = document.getElementById('animationContainer');
            if (animationContainer) {
                lottie.loadAnimation({
                    container: animationContainer,
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets10.lottiefiles.com/packages/lf20_sk5h1kfn.json' // Replace with your animation JSON URL
                });
            }


        document.addEventListener("DOMContentLoaded", function () {
            const emailInput = document.getElementById("email");
            const checkEmailButton = document.getElementById("checkEmailButton");
            const sendOtpButton = document.getElementById("sendOtpButton");
            const sendOtpSection = document.getElementById("sendOtpSection");
            const registerButtonSection = document.getElementById("registerButtonSection");
            const otpSection = document.getElementById("otpSection");
            const otpInput = document.getElementById("otp");
            const submitOtpButton = document.getElementById("submitOtpButton");
            const newPasswordSection = document.getElementById("newPasswordSection");
            const confirmPasswordSection = document.getElementById("confirmPasswordSection");
            const saveSection = document.getElementById("saveSection");
            const saveButton = document.getElementById("saveButton");
            const formResponse = document.getElementById("formResponse");

            // Prevent form submission refresh
            document.getElementById("forgotPasswordForm").addEventListener("submit", function (event) {
                event.preventDefault();
            });

            // ✅ 1. Check if Email Exists & Send OTP
            checkEmailButton.addEventListener("click", function () {
                const email = emailInput.value.trim();
                const emailTick = document.getElementById("emailTick"); // ✅ Select the tick element

                if (email === "") {
                    showError("emailError", "Email is required!");
                    emailTick.style.display = "none"; // Hide tick if empty
                    return;
                }

                fetch("http://127.0.0.1:8000/check-email/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        hideError("emailError");  // ✅ Hide error message
                        emailTick.style.display = "inline"; // ✅ Show tick if email exists

                        showSection(sendOtpSection); // Show Send OTP section
                        hideSection(otpSection);
                        hideSection(newPasswordSection);
                        hideSection(confirmPasswordSection);
                        hideSection(saveSection);

                        // ✅ Send OTP to email
                        fetch("http://127.0.0.1:8000/forgot-password/", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ email: email }),
                        })
                        .then(response => response.json())
                        .then(otpData => {
                            if (otpData.sent) {
                                showSection(otpSection);
                                startOtpTimer();
                            } else {
                                showError("formResponse", "Error sending OTP. Try again.");
                            }
                        })
                        .catch(error => console.error("Error:", error));
                    } else {
                        showError("emailError", "Email not found! Please register.");
                        showSection(registerButtonSection);
                        emailTick.style.display = "none"; // ✅ Hide tick if email not found
                    }
                })
                .catch(error => console.error("Error:", error));
            });

            // ✅ 2. Verify OTP
            submitOtpButton.addEventListener("click", function () {
                const email = emailInput.value.trim();
                const otp = otpInput.value.trim();
                if (otp === "") {
                    showError("otpError", "OTP is required!");
                    return;
                }

                fetch("http://127.0.0.1:8000/password-verify-otp/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email, otp: otp }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.verified) {
                        hideError("otpError");
                        hideSection(otpSection); // Hide OTP section
                        showSection(newPasswordSection); // Show new password section
                        showSection(confirmPasswordSection); // Show confirm password section
                        showSection(saveSection); // Show save section
                    } else {
                        showError("otpError", "Invalid OTP!");
                    }
                })
                .catch(error => console.error("Error:", error));
            });

            // ✅ 3. Reset Password
            saveButton.addEventListener("click", function () {
                const email = emailInput.value.trim();
                const newPassword = document.getElementById("newPassword").value.trim();
                const confirmPassword = document.getElementById("confirmPassword").value.trim();

                if (newPassword === "" || confirmPassword === "") {
                    showError("formResponse", "Both password fields are required!");
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showError("formResponse", "Passwords do not match!");
                    return;
                }

                fetch("http://127.0.0.1:8000/reset-password/", {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: email, new_password: newPassword }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        formResponse.textContent = "Password reset successful! Redirecting...";
                        formResponse.style.color = "green";
                        setTimeout(() => window.location.href = "login.html", 3000);
                    } else {
                        showError("formResponse", data.message);
                    }
                })
                .catch(error => console.error("Error:", error));
            });

            // ✅ Helper Functions
            function showError(id, message) {
                const errorElement = document.getElementById(id);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = "block";
                    errorElement.style.color = "red";
                }
            }

            function hideError(id) {
                const errorElement = document.getElementById(id);
                if (errorElement) {
                    errorElement.textContent = "";
                    errorElement.style.display = "none";
                }
            }

            function showSection(element) {
                if (element) {
                    element.style.display = "block";
                }
            }

            function hideSection(element) {
                if (element) {
                    element.style.display = "none";
                }
            }

            function startOtpTimer() {
                let countdown = 60;
                const otpTimer = document.getElementById("otpTimer");
                const countdownSpan = document.getElementById("countdown");

                otpTimer.style.display = "inline";
                const timerInterval = setInterval(() => {
                    countdown -= 1;
                    countdownSpan.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(timerInterval);
                        sendOtpButton.disabled = false;
                        otpTimer.style.display = "none";
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>